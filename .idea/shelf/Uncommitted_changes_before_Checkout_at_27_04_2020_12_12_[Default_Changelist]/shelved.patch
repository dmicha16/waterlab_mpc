Index: proposal_network.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>#!/usr/bin/env python3\r\n# -*- coding: utf-8 -*-\r\n\"\"\"\r\nCreated on Sun Mar 29 20:12:58 2020\r\n\r\n@author: davidm\r\n\"\"\"\r\n\r\nimport matplotlib\r\nimport matplotlib.pyplot as plt\r\n\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\nfrom pyswmm import Simulation, Nodes, Links\r\nimport networkcontrol as controller\r\nimport plotter as plotter\r\n\r\n# %%\r\n\r\ncolumns = ['tank_volume',\r\n           'tank_depth',\r\n           'tank_overflow',\r\n           'tank_inflow',\r\n           'pump_flow']\r\n\r\n# %%\r\nnetwork_df = pd.DataFrame(columns=columns)\r\n\r\nprint(network_df)\r\n\r\n# %%\r\n\r\ncount = 0\r\n\r\n# step size [seconds]\r\nTs = 30\r\n\r\nwith Simulation('epa_networks/proposal_network/proposal_network.inp') as sim:\r\n    \r\n    sim.step_advance(Ts)\r\n\r\n    pump1 = Links(sim)[\"P1\"]\r\n    tank1 = Nodes(sim)[\"Tanks1\"]\r\n\r\n    # Leave someolume in the tank to avoid dry-run of the pumps\r\n    tank_mindepth = 0.1\r\n\r\n    for idx, step in enumerate(sim):\r\n        \r\n        # call the controller here\r\n        controller.on_off(pump1, tank1)\r\n\r\n        network_df = network_df.append(pd.Series([tank1.volume, tank1.depth, tank1.flooding, tank1.total_inflow,\r\n                                                  pump1.flow], index=network_df.columns), ignore_index=True)\r\n\r\n        count += 1\r\n\r\n        print(f\"Progress {int(sim.percent_complete*100)}%\", end=\"\\r\")\r\n\r\n    t = np.linspace(0, count, count)\r\n    plotter.plot_network(network_df, Ts, t, tank1.full_depth, count)\r\n\r\n    plt.show()\r\n\r\n    print('Count =', count)\r\n\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- proposal_network.py	(revision 8f4a05ced2e38305416c84eb8203664fc62b6d91)
+++ proposal_network.py	(date 1587723601485)
@@ -6,7 +6,7 @@
 @author: davidm
 """
 
-import matplotlib
+
 import matplotlib.pyplot as plt
 
 import pandas as pd
Index: networkcontrol.py
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>\"\"\"\r\nModule for Level control\r\n\"\"\"\r\n\r\nimport casadi as ca\r\nimport mpc\r\n\r\n\r\ndef gen_mpc_solver(A, B, Hu, Hp, Q, R):\r\n    # # The wrong way of declaring inputs\r\n    # Solver inputs\r\n    # x0 = ca.SX.sym('x0', A.shape[0], 1)\r\n    # u_prev = ca.SX.sym('u_prev', B.shape[1], 1)\r\n    # ref = ca.SX.sym('ref', Hp * A.shape[0], 1)\r\n    # input_variables = ca.vertcat(ca.vertcat(x0, u_prev), ref)\r\n\r\n    # Solver inputs\r\n    input_variables = ca.SX.sym('i', A.shape[0] + B.shape[1] + Hp * A.shape[0], 1)\r\n    x0 = input_variables[0:A.shape[0], :]\r\n    u_prev = input_variables[A.shape[0]:(A.shape[0] + B.shape[1]), :]\r\n    ref = input_variables[(A.shape[0] + B.shape[1]):(A.shape[0] + B.shape[1] + Hp * A.shape[0]), :]\r\n\r\n    # Solver outputs\r\n    dU = ca.SX.sym('dU', B.shape[1] * Hu, 1)\r\n\r\n    # To formulate a MPC optimization problem we need to describe:\r\n    # Z = psi x(k) + upsilon u(k-1) + Theta dU(x) (Assuming no disturbance)\r\n    psi = mpc.gen_psi(A, Hp)\r\n    upsilon = mpc.gen_upsilon(A, B, Hp)\r\n    theta = mpc.gen_theta(upsilon, B, Hu)\r\n    predicted_states = mpc.gen_predicted_states(psi, x0, upsilon, u_prev, theta, dU)\r\n\r\n    # Cost function:\r\n    # Cost = (Z - T)' * Q * (Z - T) + dU' * R * dU\r\n    error = predicted_states - ref  # e = (Z - T)\r\n    quadratic_cost = error.T @ Q @ error + dU.T @ R @ dU\r\n    quadratic_problem = {'x': dU, 'p': input_variables, 'f': quadratic_cost}\r\n    print(quadratic_cost)\r\n\r\n    mpc_solver = ca.qpsol('mpc_solver', 'qpoases', quadratic_problem)\r\n    print(mpc_solver)\r\n\r\n    return mpc_solver\r\n\r\n\r\n# def mpc_version_1(pump,tank):\r\ndef on_off(pump, tank):\r\n    if tank.depth >= tank.full_depth * 0.5:\r\n        pump.target_setting = 5  # [0,1]\r\n\r\n    elif tank.depth <= tank.full_depth * 0.1:\r\n        pump.target_setting = 0  # [0,1]\r\n\r\n    return pump\r\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- networkcontrol.py	(revision 8f4a05ced2e38305416c84eb8203664fc62b6d91)
+++ networkcontrol.py	(date 1587979997442)
@@ -36,8 +36,10 @@
     quadratic_cost = error.T @ Q @ error + dU.T @ R @ dU
     quadratic_problem = {'x': dU, 'p': input_variables, 'f': quadratic_cost}
     print(quadratic_cost)
+    opts ={}
+    # opts= {'nWSR' : 100*(Hp*A.size1())}
 
-    mpc_solver = ca.qpsol('mpc_solver', 'qpoases', quadratic_problem)
+    mpc_solver = ca.qpsol('mpc_solver', 'qpoases', quadratic_problem,opts)
     print(mpc_solver)
 
     return mpc_solver
Index: epa_networks/proposal_network/proposal_network.rpt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>\r\n  EPA STORM WATER MANAGEMENT MODEL - VERSION 5.1 (Build 5.3.0.dev0)\r\n  --------------------------------------------------------------\r\n\r\n  This is a dummy network that has a pump, a storage unit and two subcatchments \r\n  \r\n  \r\n  *********************************************************\r\n  NOTE: The summary statistics displayed in this report are\r\n  based on results found at every computational time step,  \r\n  not just on results from each reporting time step.\r\n  *********************************************************\r\n  \r\n  ****************\r\n  Analysis Options\r\n  ****************\r\n  Flow Units ............... LPS\r\n  Process Models:\r\n    Rainfall/Runoff ........ YES\r\n    RDII ................... NO\r\n    Snowmelt ............... NO\r\n    Groundwater ............ NO\r\n    Flow Routing ........... YES\r\n    Ponding Allowed ........ NO\r\n    Water Quality .......... NO\r\n  Infiltration Method ...... MODIFIED_GREEN_AMPT\r\n  Flow Routing Method ...... KINWAVE\r\n  Starting Date ............ 03/26/2020 00:00:00\r\n  Ending Date .............. 03/26/2020 06:00:00\r\n  Antecedent Dry Days ...... 0.0\r\n  Report Time Step ......... 00:15:00\r\n  Wet Time Step ............ 00:05:00\r\n  Dry Time Step ............ 01:00:00\r\n  Routing Time Step ........ 30.00 sec\r\n  \r\n  \r\n  **************************        Volume         Depth\r\n  Runoff Quantity Continuity     hectare-m            mm\r\n  **************************     ---------       -------\r\n  Total Precipitation ......         0.024         3.000\r\n  Evaporation Loss .........         0.000         0.000\r\n  Infiltration Loss ........         0.012         1.500\r\n  Surface Runoff ...........         0.011         1.402\r\n  Final Storage ............         0.001         0.104\r\n  Continuity Error (%) .....        -0.197\r\n  \r\n  \r\n  **************************        Volume        Volume\r\n  Flow Routing Continuity        hectare-m      10^6 ltr\r\n  **************************     ---------     ---------\r\n  Dry Weather Inflow .......         0.000         0.000\r\n  Wet Weather Inflow .......         0.011         0.112\r\n  Groundwater Inflow .......         0.000         0.000\r\n  RDII Inflow ..............         0.000         0.000\r\n  External Inflow ..........         0.000         0.000\r\n  External Outflow .........         0.005         0.048\r\n  Flooding Loss ............         0.000         0.000\r\n  Evaporation Loss .........         0.000         0.000\r\n  Exfiltration Loss ........         0.000         0.000\r\n  Initial Stored Volume ....         0.000         0.000\r\n  Final Stored Volume ......         0.006         0.063\r\n  Continuity Error (%) .....        -0.084\r\n  \r\n  \r\n  ********************************\r\n  Highest Flow Instability Indexes\r\n  ********************************\r\n  All links are stable.\r\n  \r\n  \r\n  *************************\r\n  Routing Time Step Summary\r\n  *************************\r\n  Minimum Time Step           :    30.00 sec\r\n  Average Time Step           :    30.00 sec\r\n  Maximum Time Step           :    30.00 sec\r\n  Percent in Steady State     :     0.00\r\n  Average Iterations per Step :     1.00\r\n  Percent Not Converging      :     0.00\r\n  \r\n  \r\n  ***************************\r\n  Subcatchment Runoff Summary\r\n  ***************************\r\n  \r\n  ------------------------------------------------------------------------------------------------------------------------------\r\n                            Total      Total      Total      Total     Imperv       Perv      Total       Total     Peak  Runoff\r\n                           Precip      Runon       Evap      Infil     Runoff     Runoff     Runoff      Runoff   Runoff   Coeff\r\n  Subcatchment                 mm         mm         mm         mm         mm         mm         mm    10^6 ltr      LPS\r\n  ------------------------------------------------------------------------------------------------------------------------------\r\n  S1                         3.00       0.00       0.00       1.50       1.40       0.00       1.40        0.06     5.51   0.467\r\n  S2                         3.00       0.00       0.00       1.50       1.40       0.00       1.40        0.06     5.51   0.467\r\n  \r\n  \r\n  ******************\r\n  Node Depth Summary\r\n  ******************\r\n  \r\n  ---------------------------------------------------------------------------------\r\n                                 Average  Maximum  Maximum  Time of Max    Reported\r\n                                   Depth    Depth      HGL   Occurrence   Max Depth\r\n  Node                 Type       Meters   Meters   Meters  days hr:min      Meters\r\n  ---------------------------------------------------------------------------------\r\n  J1                   JUNCTION     0.03     0.04    95.04     0  03:00        0.04\r\n  Out1                 OUTFALL      0.00     0.00    85.00     0  00:00        0.00\r\n  Tanks1               STORAGE      0.34     0.66    90.66     0  05:11        0.66\r\n  \r\n  \r\n  *******************\r\n  Node Inflow Summary\r\n  *******************\r\n  \r\n  -------------------------------------------------------------------------------------------------\r\n                                  Maximum  Maximum                  Lateral       Total        Flow\r\n                                  Lateral    Total  Time of Max      Inflow      Inflow     Balance\r\n                                   Inflow   Inflow   Occurrence      Volume      Volume       Error\r\n  Node                 Type           LPS      LPS  days hr:min    10^6 ltr    10^6 ltr     Percent\r\n  -------------------------------------------------------------------------------------------------\r\n  J1                   JUNCTION     11.01    11.01     0  03:00       0.112       0.112       0.000\r\n  Out1                 OUTFALL       0.00     5.00     0  03:19           0      0.0484       0.000\r\n  Tanks1               STORAGE       0.00    11.06     0  03:02           0        0.11      -0.000\r\n  \r\n  \r\n  *********************\r\n  Node Flooding Summary\r\n  *********************\r\n  \r\n  No nodes were flooded.\r\n  \r\n  \r\n  **********************\r\n  Storage Volume Summary\r\n  **********************\r\n  \r\n  --------------------------------------------------------------------------------------------------\r\n                         Average     Avg  Evap Exfil       Maximum     Max    Time of Max    Maximum\r\n                          Volume    Pcnt  Pcnt  Pcnt        Volume    Pcnt     Occurrence    Outflow\r\n  Storage Unit           1000 m3    Full  Loss  Loss       1000 m3    Full    days hr:min        LPS\r\n  --------------------------------------------------------------------------------------------------\r\n  Tanks1                   0.034      34     0     0         0.066      66       0  05:11       5.00\r\n  \r\n  \r\n  ***********************\r\n  Outfall Loading Summary\r\n  ***********************\r\n  \r\n  -----------------------------------------------------------\r\n                         Flow       Avg       Max       Total\r\n                         Freq      Flow      Flow      Volume\r\n  Outfall Node           Pcnt       LPS       LPS    10^6 ltr\r\n  -----------------------------------------------------------\r\n  Out1                  44.86      5.00      5.00       0.048\r\n  -----------------------------------------------------------\r\n  System                44.86      5.00      5.00       0.048\r\n  \r\n  \r\n  ********************\r\n  Link Flow Summary\r\n  ********************\r\n  \r\n  -----------------------------------------------------------------------------\r\n                                 Maximum  Time of Max   Maximum    Max/    Max/\r\n                                  |Flow|   Occurrence   |Veloc|    Full    Full\r\n  Link                 Type          LPS  days hr:min     m/sec    Flow   Depth\r\n  -----------------------------------------------------------------------------\r\n  C1                   CONDUIT     11.06     0  03:02      1.02    0.00    0.04\r\n  P1                   PUMP         5.00     0  03:19              5.00\r\n  \r\n  \r\n  *************************\r\n  Conduit Surcharge Summary\r\n  *************************\r\n  \r\n  No conduits were surcharged.\r\n  \r\n  \r\n  ***************\r\n  Pumping Summary\r\n  ***************\r\n  \r\n  ---------------------------------------------------------------------------------------------------------\r\n                                                  Min       Avg       Max     Total     Power    % Time Off\r\n                        Percent   Number of      Flow      Flow      Flow    Volume     Usage    Pump Curve\r\n  Pump                 Utilized   Start-Ups       LPS       LPS       LPS  10^6 ltr     Kw-hr    Low   High\r\n  ---------------------------------------------------------------------------------------------------------\r\n  P1                      44.86           1      0.00      5.00      5.00     0.048      0.74    0.0  100.0\r\n  \r\n\r\n  Analysis begun on:  Tue Apr 21 09:33:22 2020\r\n  Analysis ended on:  Tue Apr 21 09:33:23 2020\r\n  Total elapsed time: 00:00:01
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- epa_networks/proposal_network/proposal_network.rpt	(revision 8f4a05ced2e38305416c84eb8203664fc62b6d91)
+++ epa_networks/proposal_network/proposal_network.rpt	(date 1587727034315)
@@ -186,6 +186,6 @@
   P1                      44.86           1      0.00      5.00      5.00     0.048      0.74    0.0  100.0
   
 
-  Analysis begun on:  Tue Apr 21 09:33:22 2020
-  Analysis ended on:  Tue Apr 21 09:33:23 2020
-  Total elapsed time: 00:00:01
\ No newline at end of file
+  Analysis begun on:  Fri Apr 24 13:17:12 2020
+  Analysis ended on:  Fri Apr 24 13:17:14 2020
+  Total elapsed time: 00:00:02
\ No newline at end of file
Index: .idea/waterlab_mpc.iml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<module type=\"PYTHON_MODULE\" version=\"4\">\r\n  <component name=\"NewModuleRootManager\">\r\n    <content url=\"file://$MODULE_DIR$\" />\r\n    <orderEntry type=\"jdk\" jdkName=\"Python 3.7 (waterlab_mpc)\" jdkType=\"Python SDK\" />\r\n    <orderEntry type=\"sourceFolder\" forTests=\"false\" />\r\n  </component>\r\n  <component name=\"PyDocumentationSettings\">\r\n    <option name=\"renderExternalDocumentation\" value=\"true\" />\r\n  </component>\r\n</module>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- .idea/waterlab_mpc.iml	(revision 8f4a05ced2e38305416c84eb8203664fc62b6d91)
+++ .idea/waterlab_mpc.iml	(date 1587726940544)
@@ -5,7 +5,4 @@
     <orderEntry type="jdk" jdkName="Python 3.7 (waterlab_mpc)" jdkType="Python SDK" />
     <orderEntry type="sourceFolder" forTests="false" />
   </component>
-  <component name="PyDocumentationSettings">
-    <option name="renderExternalDocumentation" value="true" />
-  </component>
 </module>
\ No newline at end of file
Index: .idea/other.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+><?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project version=\"4\">\r\n  <component name=\"PySciProjectComponent\">\r\n    <option name=\"PY_SCI_VIEW\" value=\"true\" />\r\n    <option name=\"PY_SCI_VIEW_SUGGESTED\" value=\"true\" />\r\n  </component>\r\n</project>
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- .idea/other.xml	(revision 8f4a05ced2e38305416c84eb8203664fc62b6d91)
+++ .idea/other.xml	(date 1587727295800)
@@ -1,7 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <project version="4">
   <component name="PySciProjectComponent">
-    <option name="PY_SCI_VIEW" value="true" />
     <option name="PY_SCI_VIEW_SUGGESTED" value="true" />
   </component>
 </project>
\ No newline at end of file
diff --git MPC_Plotter.py MPC_Plotter.py
new file mode 100644
